<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="magma&#39;s fe blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="magma&#39;s fe blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="magma&#39;s fe blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>magma's fe blog</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">magma's fe blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/02/2017-01-04-why-react/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magma's fe blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/02/2017-01-04-why-react/" itemprop="url">why react?</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-02T00:00:00+08:00">
                2017-01-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>使用react+redux差不多一年了，是时候总结下，why react。其实我在地铁上、或者蹲坑的时候也会想这些问题，但是所有没有梳理的形成记录的思考都不够深入，至少你在和别人讨论的时候，很难有条理地表达出来。</p>
</blockquote>
<h2 id="单向数据流，数据驱动"><a href="#单向数据流，数据驱动" class="headerlink" title="单向数据流，数据驱动"></a>单向数据流，数据驱动</h2><p>打开控制台看jquery写的界面，各种DOM操作，这给我的感觉就像在c语言中狂用goto一样，因为缺少对数据的聚合和抽象，可能一个函数里面耦合了各种操作，都没有办法去给这个函数命名（当然如果逻辑清晰思维有条理的程序员依然可以做到解耦模块化——但是框架的目的很多是为了约束之外的人）。</p>
<p>或者是backbone之类的框架，模版和数据分离。。。。</p>
<p>View层完全变成一个可预测易控制的函数，这样我们能分出更多的精力来设计——关注点分离，表达完整全面的业务数据流动。而数据驱动view层的渲染这种 Mapping，就固化了，这类思想与ORM一致。——这里我要扯蛋，泛化了讲，计算机世界里面各处的实现都是非常类似，比如各种缓存、映射、锁等——从服务器、网关到前端，都有同样类似的概念。</p>
<h2 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h2><p>在我小时候，总是被教育不要思维定势，于是我屡屡离经叛道，思维非常混乱。在我工作越来越忙的时候，我才发现思维定势不就是缓存吗？对于固定的输入我们不需要每次去计算结果，直接调用“思维定势”这个缓存就行了。只要判断好输入，思维定势非常有优势。</p>
<p>我为什么要扯这个蛋？一个好的框架，它的设计理念命中程序员足够的缓存，又将这些缓存有效组织起来创造新的东西，那么就是一个好的框架。比如学了整个大一的C语言和汇编，大二忽然接触了html，第一节课课后我们都会说“什么鬼？”，有了旧人，我们总会在接触新人的时候拿来做对比。如果一个框架与它支持的语言在理念上相去甚远，那么第一次见面一定不会那么愉快，我们需要花更多的时候去理解它。</p>
<p>首先JSX与html语法类似，组件即元素，父子关系非常直观。纵然对于只写过 html hello world 的人都可轻易接受，套用概念。</p>
<h2 id="学习曲线"><a href="#学习曲线" class="headerlink" title="学习曲线"></a>学习曲线</h2><p>react的概念较以前的JS MV* 框架，较为新颖，然后它的学习成本并不高。只要掌握了组件的生命周期，props和state，基本就可以开干了。我觉得可以在一天之内上手项目。</p>
<h2 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h2><p>react 才出来的时候社区讨论最多的是它的性能，它的虚拟DOM，对于萌新来说，的确屌炸天。但是无论是它的虚拟dom，还是shouldComponentUpdate，react只是将其当作概念宣传出来了——我的意思是说，很多老手在纵然使用原生js开发的时候，也会多少有这类实现。</p>
<p>性能、虚拟DOM只是注意到了这个问题，并提供了框架级的解决方案。我们团队的新成员，依然会在render、在componentWillRecievProps中创建新的对象，导致很多不必要的刷新。可能会有人反驳说，这是你们的使用姿势不对。但从我的角度来讲，会使用正确姿势的，并理解为什么，用原生js、用其他框架依然能达到react所谓的性能。</p>
<h2 id="整体方案，配套齐全"><a href="#整体方案，配套齐全" class="headerlink" title="整体方案，配套齐全"></a>整体方案，配套齐全</h2><p>react的社区异常繁荣，各种和其他库的结合都有非常多的实践。例如使用immutable做pure render，使用redux管理数据，前端工程化的方案也是配套齐全的。</p>
<h2 id="框架和人"><a href="#框架和人" class="headerlink" title="框架和人"></a>框架和人</h2><p>小型应用,一次性应用一般还没上升到可维护性的需要，用框架可能都嫌重。我们的项目是SPA的应用，非常复杂。分为设计态和渲染态，设计态生产DSL，渲染态解析DSL。REACT和REDUX完全hold住了。</p>
<p>在近两年的前端研发中（前面一年做的是同一个项目，属于调研探索设计阶段，是使用backbone做的），我觉得框架和人相比，还是人比较重要，有设计能力、有意识去层次化结构化组织代码的程序员使用backbone、argular、甚至是jquery与使用react并不会有多少实质性的区别，因为他们的思维在框架之上，使用框架是在使用一种工具去做事情。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/02/2017-01-02-2017-plans/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magma's fe blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/02/2017-01-02-2017-plans/" itemprop="url">2017年规划</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-02T00:00:00+08:00">
                2017-01-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>a goal is  a dream with a deadline.要有截止日期的概念。本年的计划分季度执行，每季度结束时盘点。</p>
</blockquote>
<h2 id="第一季度（清债）"><a href="#第一季度（清债）" class="headerlink" title="第一季度（清债）"></a>第一季度（清债）</h2><blockquote>
<p>前端</p>
</blockquote>
<p>这是本职工作，所以单独列出一个章节，并且放在第一位。以下列表是我在16年最后三个月记录的点，第一季度需要调研完：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line">1. viewport,rem</div><div class="line"></div><div class="line">2. react 的render children</div><div class="line"></div><div class="line">3. 研究promise,fetch，异步方案</div><div class="line"></div><div class="line">4. formdata，写一个上传组件</div><div class="line"></div><div class="line">5. pjax vs ajax，pagelet</div><div class="line"></div><div class="line">6. chrome插件，解析平台组件的结构</div><div class="line"></div><div class="line">7. 长连接和短连接，使用img.src预置连接</div><div class="line"></div><div class="line">8. iframe对history的影响</div><div class="line"></div><div class="line">9. 为何setState被设计成异步</div><div class="line"></div><div class="line">10. 媒体查询</div><div class="line"></div><div class="line">11. source map的原理</div><div class="line"></div><div class="line">12. CA</div><div class="line"></div><div class="line">13. flux</div><div class="line"></div><div class="line">14. 研究cookie-free的实现</div><div class="line"></div><div class="line">15. 浏览器高并发 http://www.browserscope.org/?category=network&amp;v=top</div><div class="line"></div><div class="line">16. BEM css 命名法</div><div class="line"></div><div class="line">17. 移动端click事件延迟300ms的设计</div><div class="line"></div><div class="line">18. script 的 scrossorigin属性</div><div class="line"></div><div class="line">19. Object.keys取数据时，是否会丢失顺序。对象上属性的数据又是什么？</div><div class="line"></div><div class="line">20. xhr请求是如何取消的，是否是父环境销毁就就会自动取消</div><div class="line"></div><div class="line">21. 为何使用React，它的优秀之处到底在什么地方？</div><div class="line"></div><div class="line">22. SPA的性能前端性能优化</div><div class="line"></div><div class="line">23. arguments竟然不是真正的Array</div><div class="line"></div><div class="line">24. window.getComputedStyle</div><div class="line"></div><div class="line">25. cssom</div><div class="line"></div><div class="line">26. debounce 与 throttle</div><div class="line"></div><div class="line">27. react-redux + react-router</div><div class="line"></div><div class="line">28. 正则表达式的优化</div><div class="line"></div><div class="line">29. let const在闭包中的表现</div><div class="line"></div><div class="line">30. getter setter</div><div class="line"></div><div class="line">31. onload document.ready</div><div class="line"></div><div class="line">32. XSS</div><div class="line"></div><div class="line">33. socks.io</div><div class="line"></div><div class="line">34. requestAnimationFrame</div><div class="line"></div><div class="line">35. deepclone的实现专题，特别注意JSON.parse会丢失一些数据                                                                                                              </div><div class="line">36. 构建js sandbox</div><div class="line"></div><div class="line">37. es6 decorator</div><div class="line"></div><div class="line">38. 增加垂直居中方式：flex+transform</div><div class="line"></div><div class="line">39. js打印视图</div><div class="line"></div><div class="line">40. store.subscribe异步属性</div><div class="line"></div><div class="line">41. getBoundingClientRect</div><div class="line"></div><div class="line">42. React 优雅选择性渲染</div><div class="line"></div><div class="line">43. 结合gitpage、路由，实现一个前后端分离</div><div class="line"></div><div class="line">44. draggable</div><div class="line"></div><div class="line">45. visible:hidden的ele是否连事件也没有了？</div></pre></td></tr></table></figure>
<blockquote>
<p>node</p>
</blockquote>
<p>第一季度啃完朴灵的《深入浅出Node JS》,如果时间有富余，则开始做个人项目。</p>
<blockquote>
<p>工作</p>
</blockquote>
<ol>
<li>完成布局的设计和demo。其中设计包含设计态和渲染态，容器支持渲染特定组件（继承、替换）、布局功能。</li>
<li>控制团队代码质量。</li>
</ol>
<h2 id="第二季度（系统化）"><a href="#第二季度（系统化）" class="headerlink" title="第二季度（系统化）"></a>第二季度（系统化）</h2><blockquote>
<p>前端</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">以下为系统性知识构建：</div><div class="line">1. es6</div><div class="line">2. es7</div><div class="line">3. css，读完《css权威指南》和css3的规范。</div><div class="line">4. 可视化</div></pre></td></tr></table></figure>
<blockquote>
<p>算法</p>
</blockquote>
<p>读完《算法导论》，用node实现书上描述的所有算法。</p>
<blockquote>
<p>工作</p>
</blockquote>
<ol>
<li>实现布局。</li>
<li>构建团队内部的code-review机制，不需要我自己参与。</li>
<li>做一个全栈的教程，对团队进行培训。</li>
</ol>
<h2 id="第三季度（深入）"><a href="#第三季度（深入）" class="headerlink" title="第三季度（深入）"></a>第三季度（深入）</h2><blockquote>
<p>前端</p>
</blockquote>
<p>1.深入对比各大主流前端框架。<br>2.开发一个移动端的项目。</p>
<blockquote>
<p>node</p>
</blockquote>
<p>研读Express的源码。</p>
<blockquote>
<p>算法可视化</p>
</blockquote>
<p>在上季度的基础上，做一套教程，用可视化的方式演示算法。</p>
<blockquote>
<p>工具</p>
</blockquote>
<ol>
<li>调研各种提高工作效率的工具，实践。</li>
<li>精通nginx</li>
</ol>
<blockquote>
<p>工作</p>
</blockquote>
<ol>
<li>做一个面向对象、抽象的教程。</li>
</ol>
<h2 id="第四季度-融合"><a href="#第四季度-融合" class="headerlink" title="第四季度(融合)"></a>第四季度(融合)</h2><blockquote>
<p>前端</p>
</blockquote>
<p>读v8引擎的源码。</p>
<blockquote>
<p>网络与安全</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1. sockets编程</div><div class="line">2.《图解TCP/IP》《TCP/IP 详解》卷一</div><div class="line">3.《白帽子讲web安全》</div></pre></td></tr></table></figure>
<blockquote>
<p>博客</p>
</blockquote>
<p>基于本年的研究，写一些系统性的深入的博客。</p>
<h2 id="个人项目"><a href="#个人项目" class="headerlink" title="个人项目"></a>个人项目</h2><ol>
<li><p>chrome插件，辅助平台组件的开发。</p>
</li>
<li><p>前端模版引擎。node，js 实现。</p>
</li>
<li><p>布局引擎。node,js实现。</p>
</li>
<li><p>静态站点生成器。node实现。<br>它在文字处理上有以下功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1. 数字和英文显示在中文中时，前后有空格。</div></pre></td></tr></table></figure>
</li>
<li><p>代码压缩器。node实现。</p>
</li>
<li><p>在线ppt生成。node+mysql实现。</p>
</li>
<li><p>SPA级的博客系统。</p>
</li>
<li><p>在项目7的基础上做一个日报、周报集成系统。</p>
</li>
</ol>
<h2 id="健康"><a href="#健康" class="headerlink" title="健康"></a>健康</h2><p>每季度完成跑步里程 250公里，体重控制到130斤以下。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>程序员不仅创造工具，也被工具所塑造。希望自己在新的一年内，是在驾御工具，而不是被工具所驾御。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/02/2016-12-30-fade-into-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magma's fe blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/02/2016-12-30-fade-into-world/" itemprop="url">淡入世界</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-02T00:00:00+08:00">
                2017-01-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>勃起的青春</p>
</blockquote>
<p>虽然新年未到，但慵懒的气息已经在公司里面漫延。这是我第一次注意到这种现象，也许以前也有吧，可能是我不一样了，这样的被驯服的感觉。以前读王小波的《黄金时代》，读到他那次“最雄浑的勃起”，我掩书沉思。那年我也是二十一岁，可是记忆中并没有哪次的勃起让我记忆深刻。</p>
<p>也许，也许在未来吧，我想。</p>
<p>我又想起在日本的时候，那时正是仲夏，晚上下班后喜欢去海边走一走。东京湾的台场海滨公园，就在公司楼下，有时中午吃完饭也去逛一逛。那段时间一度让我想在日本定居，一个人，静静地走，看着身穿国中校服的少年赤足奔跑在沙滩上，青春在唱歌。有一次夜里，我慢慢地走在柔光的水边，忽然两个女学生说着悄悄话就大笑起来，我侧脸去看的时候，她们急忙掩口，我走远的时候又大笑起来。</p>
<p>青春好像就那么溜走了，其实那时我才二十四，现在不过二十八。我并不孤单，无论什么时候，我从来没有离开什么地方的感觉，也没有回到什么地方的感觉。离开，又或者回归，只是同一件事吧。</p>
<blockquote>
<p>流离之人</p>
</blockquote>
<p>江南说，“流离之人追逐幻影”，我起先并不这么认为：流离的人没有什么陪伴，通常连身边的小动物都格外珍惜，就在《我是传奇》中威尔·史密斯痛苦地勒死自己的狗时，我真切地感受到那种孤单。我记不清那时的年纪了，也许也是二十一岁。现在，还有四十天我就二十八岁，现在，我体会到这句话的真实含意。</p>
<p>追逐幻影，才让一个人流离。那些被迫流离的，并不是流离之人。</p>
<p>自从毕业以来，我一直避免深入思考感性的东西，我不再写诗、不再写小说、不再尝试去学一门乐器、不听伤感的歌、不在下雨天出门、不再眺望远方，只是不断地写代码、逻辑思维、看客观的书。但我还是偶尔会想起爷爷，爷爷去世那年我刚毕业，在外面找工作。他们为了不让我分心，没有告诉我真实的情况，所以我没能见爷爷最后一面。</p>
<p>我不知道这是不是一个契机，或者只是给自己找的一个借口，但是从那以后，我看淡了许多事。我不再装深沉了，封闭自己丰富的感性，尽最大的努力取乐这个世界，变的平平淡淡。这个过程中，有我老婆的巨大功劳。</p>
<p>就这样，我完成了对自己的背叛。</p>
<p>他们会说，你看这就是你所擅长的，你干的还不错。然而只是我自己才知道，我用一双没有近视的双眼完成了从小学到高中一路德智体美劳的全面领先，在整个高中混迹于网吧之中依然能考上一所还不错的大学，我恶劣的傲慢就是因为长年感觉到的优势所养成。好汉不提当年，我只是在说明自己做了何种的背叛。</p>
<p>也许没有我老婆，我可能会是个流离之人，肆意纵横地为所欲为，也可能像海子一样卧轧自杀——总之，把聪明才智用在“正道”上的可能性微乎其微。</p>
<p>就在现在，我在想是否要做出什么改变，做一个释放天性的人，还是一个持续改造自我的刽子手——也许从这自然的措辞中，已经听到了内心的声音。</p>
<p>有的时候，很自豪于这种改变自己的能力，因为这挺不容易的。</p>
<blockquote>
<p>双刃剑</p>
</blockquote>
<p>我想，也许我不能矫枉过正，所有带来改进的措施都有可取之处，不能因为纯粹地使用某种方式，看清了它所带来的害处便对其进行否定。为什么我不能糅合多种方式，也许这样我就像能像一颗棱角锋利的石子，在人生的河流施入中游的时候，变成一颗外柔内刚的鹅卵石？</p>
<p>取其精华、舍其糟粕，何其之难。</p>
<p>这个时代的变化速度远超过往任何时候，人生的函数有无数的输入，在你来不及处理一个东西的时候，它已经废弃了。这个时代，对于完美主义者，不怎么友好，因为变数太多，细节永远追求不完，追求细节会丧失大局观…</p>
<blockquote>
<p>淡入世界</p>
</blockquote>
<p>二十五岁之前，我喜欢与众不同，哗众取宠，提出不一样的观点。二十五岁之后，我喜欢当一个旁观者，我甚至都当起了自己的旁观者。</p>
<p>2017年，我要做一个平静的人，时刻保持一颗平常心，感谢所有的过往，成就如今的自己。在出世与入世之间保持平衡，保持谦虚、保持进取，做一个温润如玉的技术人。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/01/2017-01-01-2016-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magma's fe blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/01/2017-01-01-2016-summary/" itemprop="url">2016年总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-01T00:00:00+08:00">
                2017-01-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>2016年，比较匆忙的一年。思考的时间非常少，是被推着走的一年。总体来说，勉强及格。</p>
</blockquote>
<h2 id="工作"><a href="#工作" class="headerlink" title="工作"></a>工作</h2><p>2016年主要的时间都花在工作上了，虽然很忙，但是产出时间比较低 —— 估算了下，可能只有我过去效率的一半。虽然整年做的事情较多，但是用如此多的加班时间，真是得不偿失，有杀鸡取卵的感觉。我比较注重效率，所以今年过得颇有挫败感。</p>
<p>今年承担的管理协作任务，除了技术上的指导和技术方案，其他事情我都不热情，占用的时间太多。</p>
<h2 id="专业"><a href="#专业" class="headerlink" title="专业"></a>专业</h2><p>15年1月份，当时面试我的人问我职业规划，我说：“接下的两年内成为前端专家”。如今两年将过，这个目标却不好说到底有没有实现，因为“专家”这个词，市面上和个人会有不同的定义。总得来说，勉强算一个专家吧。2015年算是入门，2016年建立了系统前端知识框架。目前在法术器上的应该没有不明白、不能应用的。缺乏的是道上的能力。</p>
<p>除了前端，其他技术知识分布如下：</p>
<ul>
<li>.net : 只是去年帮一个实习生做了下毕业设计，最近一年半，尤其是换了mac之后，完全没有碰过了。打算完全放弃。</li>
<li>c++ :换了mac后，只写了几个小程序，用来验证算法的，几乎没碰。</li>
<li>汇编 :买了本汇编的书，本来想加深下对系统低层的理解，看了几十页之后不了了之。准备暂停探索。</li>
<li>算法 :基本的排序，树图数据结构的相关算法经常温习。但是实战的太少。需要做一些复杂的迷题。</li>
<li>网络 :http/tcp协议经常温习，nginx练熟了很多，对缓存策略尤其熟练。</li>
<li>node :断断续续看过各个相关知识点，随手也写过一些demo，但是没有系统性的学习。</li>
<li>php :写过不少代码，主要是自己调研一些前后端的方案时使用。编程应该问题不大。</li>
<li>python :看到编程语言排行榜上快速上升，调查了下，觉得自己需要了解下这门“胶水语言”，买了本书，看了几十页。不了了之。</li>
<li>文史哲 :今年精读的书不多，应该只有三十本左右。泛读的不少，可能不下一百本。但都没有反刍，写读书笔记。</li>
</ul>
<h2 id="家庭"><a href="#家庭" class="headerlink" title="家庭"></a>家庭</h2><p>每周陪家人一天，其他时间基本都是早出晚归，加班。女儿和我不是很亲，因为我很少带她玩。自己觉得有太多的事情可以做，人生有太多的理想，很多事过于急切，忽略了家庭。</p>
<h2 id="健康"><a href="#健康" class="headerlink" title="健康"></a>健康</h2><p>体重从去年的135涨到了现在的150，开始有严重的背疼，易疲劳。跑步总里程只有八十几公里。虽然体检没有任何问题，但是我知道健康已经亮起了红灯。</p>
<h2 id="性格与社交"><a href="#性格与社交" class="headerlink" title="性格与社交"></a>性格与社交</h2><blockquote>
<p>君子如玉</p>
</blockquote>
<p>性格比以前好很多，不再是一个愤青，以前像古老的谜语里描述木工的刨子一样“荡尽不平事”，为人尖酸刻薄，想要证明无数的人是错的。后来我只对亲近的人这样，觉得其他人不值得我耗费精力。如今连家人我也只是苦笑了之。忽然发现海阔天空了，我有真正的精力和心情去做自己的事情。其实哪有那么多道理可讲，人们都会选择自己生活的方式，想改变的不想改变的，仅此而已。</p>
<blockquote>
<p>找到那些比你水平更高、更聪明的人，尽量和他们在一起，吃饭或者喝咖啡，向他们讨教，了解他们拥有的知识。你的职业，甚至你的生活，都会因此变得更好。</p>
</blockquote>
<p>2016年，还是一如既往地傲慢。对于技术较low、废话又多的人经常不耐烦，对没有重点、把我叫过去全程我不用说一句话的会议超级排斥，极容易吊儿郎当。我花费很多精力来改变自己的这种态度，但是收效甚微。</p>
<p>经过多次沉思之后，我得出一个结论，这是我的天性，很难去改。我决定不改了，把精力放在其他方面，这块就随缘吧。希望能找到能压服我的团队和leader。</p>
<h2 id="三观"><a href="#三观" class="headerlink" title="三观"></a>三观</h2><p>世界观有了很大变化，更加趋于理性、唯物主义，降低了对所有人的要求、加强了对自我的要求。</p>
<p>价值观和人生观都有很多改变，不再时刻追求永恒的东西、排斥频繁变化的事物，认识到变化的事物中一样有永恒的东西——而这些更加珍贵。另外彻底奉行终身学习和苦行，非常排斥享乐主义，希望固化自己的生活，减少生活的复杂度。</p>
<h2 id="时间精力分布"><a href="#时间精力分布" class="headerlink" title="时间精力分布"></a>时间精力分布</h2><blockquote>
<p>下班的时间是成长相关最重要的时间 。</p>
</blockquote>
<p>2016年做的很差，计划性很差，看小说和玩游戏浪费了至少三分之一以上的时间。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>2016年工作上还算顺利，个人成长上负分——主要原因是想要改造压制自己，变成更加专业的职场人士，结果引起了更加强大的反弹，让自己迷茫了很久。不是元旦这几天有时间反思，还不一定能找出原因所在。在下一年内不能再干这种蠢事，释放天性，把自己的智力用在正确的地方，而不是和自己作对。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/23/2016-12-02-how-do-browser-render-pages/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magma's fe blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/23/2016-12-02-how-do-browser-render-pages/" itemprop="url">浏览器如何渲染页面及据此的性能优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-23T00:00:00+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>浏览器渲染页面的具体步骤如下：</p>
<ul>
<li>DOM tree 的构建</li>
<li>CSSOM tree 的构建</li>
<li>Render tree 的构建: 合并 DOM tree 和 CSSOM tree</li>
<li>Layout (我们常说的 reflow 就是与此有关): 从根节点开始计算 render tree 上每个 node 的盒模型。</li>
<li>Paint: 将上一步计算出的每个节点绘制到屏幕上，像素化、栅格化</li>
</ul>
<p>render tree 上都是可见的、将要被渲染的元素。</p>
<h2 id="repaint"><a href="#repaint" class="headerlink" title="repaint"></a>repaint</h2><p>很多地方说repaint仅指不带有回流行为的再次 paint,但实际上 repaint 就是重新执行 paint，跟有没有回流没有什么关系，它们是两个不同的概念。当页面需要渲染成跟之前不一样的时候，浏览器就会重绘。绝大多数reflow都会引起repaint,但是repaint不一定都是由reflow引起的，比如滚动页面，render tree 和 Laout 完全不需要任何计算，仅需要重绘即可。再比如将一个元素的 visibility 的值设置为hidden，没有reflow，只有repaint。</p>
<h2 id="reflow"><a href="#reflow" class="headerlink" title="reflow"></a>reflow</h2><p>页面回流指触发上述第四个步骤（Layout）的行为，比如将一个元素脱离普通文档流，它的后续元素和其父元素都有可能需要重新计算盒模型。</p>
<p>引起回流的操作：</p>
<ul>
<li>改变window大小</li>
<li>改变字体大小</li>
<li>改变height,width,position,display</li>
<li>增删节点</li>
<li>移动设备的横竖屏切换</li>
</ul>
<p>并不是所有的reflow都会引起repaint，例如在一个很长的页面底部插入了一个元素（当前scrollTop为0），触发了reflow，但是页面无需repaint。</p>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p>根据浏览器呈现页面的步骤，可以做以下的性能优化（仅仅针对reflow,repaint并没有多少程序员可以介入的地方——而且阻止了reflow，则很多无效的repaint自然而然就优化掉了）：</p>
<ol>
<li><p>将包含动画的元素独立出元素较多的文档流，这样动画引发的 reflow 仅需要 layout 动画所在的文档流。</p>
</li>
<li><p>需要频繁操作一个元素及其后代的css属性，引起多次reflow的，可以使用切换类的方式，或者将此元素隐藏，操作完之后再显示。生成元素也是如此，一次将元素生成完整再将其插入到dom中。</p>
</li>
<li><p>如果对window绑定了resize事件，做一个debounce。</p>
</li>
<li><p>避免使用table布局，除了table之外，其他的元素渲染都是流式的（从左到右，从上到下），后代元素的渲染不会影响前面元素的位置，但是table中各个cell的渲染会彼此影响。所以改变任何cell都有可能引起整个table的reflow,而且这种reflow计算的成本比遵守流式布局的元素大很多。</p>
</li>
<li><p>不要频繁读取一个元素的 computed style，这类style是动态的，而且是lazy属性的，读取的时候会触发layout去计算它的值，比如offsetWidth等等。</p>
</li>
</ol>
<h2 id="动画优化"><a href="#动画优化" class="headerlink" title="动画优化"></a>动画优化</h2><p>设计总是需要不断调整和固化某些复杂的组合，以适应现实的场景。比如对动画的需求，催生了一些js动画库，基本原理就是循环改变元素的属性达到渐变的效果。这样疯狂的reflow和repaint铁定是无法避免了。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction" target="_blank" rel="external">render-tree-construction</a><br><a href="http://javascript.tutorialhorizon.com/2015/06/06/what-are-reflows-and-repaints-and-how-to-avoid-them/" target="_blank" rel="external">What are reflows and repaints and how to avoid them</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/14/2016-11-14-browser-max-connections/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magma's fe blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/14/2016-11-14-browser-max-connections/" itemprop="url">浏览器的最大连接</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-14T00:00:00+08:00">
                2016-11-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>项目中性能相关的日志绑定到组件的生命周期，一瞬间渲染多个组件会发出非常多的日志请求。也是大意，因为日志请求与其他数据请求不同域，就觉得没有问题。然后上线之后，主要的数据请求竟然出现了排队的现象。原因是瞬间的log达到上百条，经过一翻查找，原来浏览器并发连接是有限制的，而且一般不超过15个。——这个很久之前看过一篇文章，但是忘记了。所以这里再详细地记录下这个问题。</p>
<h2 id="相关数据"><a href="#相关数据" class="headerlink" title="相关数据"></a>相关数据</h2><p><img src="/image/ua_connections.png"></p>
<p>这个数据来源于 <a href="http://www.browserscope.org/?category=network&amp;v=top" target="_blank" rel="external">http://www.browserscope.org/?category=network&amp;v=top</a></p>
<p>浏览器对每个域名的并发基本是个位数，无关域名的并发也不大。</p>
<h2 id="针对此特性的性能优化"><a href="#针对此特性的性能优化" class="headerlink" title="针对此特性的性能优化"></a>针对此特性的性能优化</h2><p>这节是凑字数的，因为仅仅是记录上面那些这篇文章未免太短小了。</p>
<h3 id="css-spirit"><a href="#css-spirit" class="headerlink" title="css spirit"></a>css spirit</h3><p>雪碧图和js/css合并请求一样，将资源合并，一条请求搞定，不仅减少了占用浏览器的并发请求，而且也节省了带宽 —— 因为每个请求的建联也是非常可观的消耗。</p>
<h3 id="js-css-combine"><a href="#js-css-combine" class="headerlink" title="js/css combine"></a>js/css combine</h3><p>在上面说过了，略。</p>
<h3 id="load-imgs-on-demand"><a href="#load-imgs-on-demand" class="headerlink" title="load imgs on demand"></a>load imgs on demand</h3><p>这个技术是前端必备了，就是开始的时候img的src是空的，不加载图片。当此图片滚动到可视区域时（或者其他情景，反正就是这个图片需要展示了），再给它当年没给的真实src。<br>同时也指按设备、网络的情况下加载不同清晰度的图片。</p>
<h2 id="减少网络请求数据量的优化"><a href="#减少网络请求数据量的优化" class="headerlink" title="减少网络请求数据量的优化"></a>减少网络请求数据量的优化</h2><h3 id="浏览器缓存"><a href="#浏览器缓存" class="headerlink" title="浏览器缓存"></a>浏览器缓存</h3><p>详见<a href="/2016/11/04/cache-control.html">浏览器缓存策略</a></p>
<h3 id="cookie-free-domain"><a href="#cookie-free-domain" class="headerlink" title="cookie-free domain"></a>cookie-free domain</h3><p>这是个新的约定。简单来讲就是向此域名请求静态资源时，不带cookie。—— 对的，在巨大的访问量下，做优化的前辈们真是做到了极致，搞得我都想提议把 http:// 中的两个斜杠去掉了。</p>
<h3 id="资源压缩"><a href="#资源压缩" class="headerlink" title="资源压缩"></a>资源压缩</h3><p>极尽所有的压缩能力，js/css开发完uglify一次，传输的时候再开个gzip什么的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/05/2016-11-05-amd-commonjs-umd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magma's fe blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/05/2016-11-05-amd-commonjs-umd/" itemprop="url">js模块化规范——AMD,CommonJS,UMD</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-05T00:00:00+08:00">
                2016-11-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>我在搜索js模块化关键词时，搜索到一篇非常通俗易懂的文章，<a href="http://davidbcalhoun.com/2014/what-is-amd-commonjs-and-umd/" target="_blank" rel="external">http://davidbcalhoun.com/2014/what-is-amd-commonjs-and-umd/</a>，我写不出更好的，所以写了个读博的笔记。</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>AMD是等依赖全部加载好了，才构建输出模块，模块的定义中不包含依赖的加载逻辑。CMD的依赖加载写在模块定义中。UMD是兼容AMD和CMD的模块定义方式。</p>
<h2 id="AMD"><a href="#AMD" class="headerlink" title="AMD"></a>AMD</h2><p>AMD的语法如下：</p>
<blockquote>
<p>define(id?,deps?,factory)</p>
</blockquote>
<p>deps中的依赖会索引到依赖模块的实体作为参数数组传入模块的定义factory中，factory要等依赖全部加载完才会执行。我读完requirejs的源码，写了一个简易的实现：(simple_requirejs)[/2016/10/31/simple-require-js.html]。</p>
<p>下面定义了一个foo模块，依赖于jquery:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// filename: foo.js</span></div><div class="line">define([<span class="string">'jquery'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">$</span>) </span>&#123;</div><div class="line">    <span class="comment">//methods</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params"></span>)</span>&#123;&#125;;</div><div class="line">    <span class="comment">//exposed public methods</span></div><div class="line">    <span class="keyword">return</span> myFunc;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>以上的factory执行的时候首先要获得jquery模块的输出，并作为$传入到factory中作为参数。</p>
<h2 id="CommonJS"><a href="#CommonJS" class="headerlink" title="CommonJS"></a>CommonJS</h2><p>定义语法如下：</p>
<blockquote>
<p>define(factory(){<br>    var dep1 = require(“dep1”);<br>    var dep2 = require(“dep2”);<br>})</p>
</blockquote>
<p>CommonJS号称 as lazy as possible。</p>
<p>下面同样定义一个foo模块，依赖于jquery:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//filename: foo.js</span></div><div class="line"></div><div class="line"><span class="comment">//dependencies</span></div><div class="line"><span class="keyword">var</span> $ = <span class="built_in">require</span>(<span class="string">'jquery'</span>);</div><div class="line"></div><div class="line"><span class="comment">//methods</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params"></span>)</span>&#123;&#125;;</div><div class="line"></div><div class="line"><span class="comment">//exposed public method (single)</span></div><div class="line"><span class="built_in">module</span>.exports = myFunc;</div></pre></td></tr></table></figure>
<h2 id="UMD"><a href="#UMD" class="headerlink" title="UMD"></a>UMD</h2><p>AMD与CMD差不多一样流行，于是UMD这种能被这两种模块定义加载的定义出现了。</p>
<p>语法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">root, factory</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd) &#123;</div><div class="line">        <span class="comment">// AMD</span></div><div class="line">        define([<span class="string">'jquery'</span>], factory);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> exports === <span class="string">'object'</span>) &#123;</div><div class="line">        <span class="comment">// Node, CommonJS-like</span></div><div class="line">        <span class="built_in">module</span>.exports = factory(<span class="built_in">require</span>(<span class="string">'jquery'</span>));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Browser globals (root is window)</span></div><div class="line">        root.returnExports = factory(root.jQuery);</div><div class="line">    &#125;</div><div class="line">&#125;(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$</span>) </span>&#123;</div><div class="line">    <span class="comment">//    methods</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">myFunc</span>(<span class="params"></span>)</span>&#123;&#125;;</div><div class="line"></div><div class="line">    <span class="comment">//    exposed public method</span></div><div class="line">    <span class="keyword">return</span> myFunc;</div><div class="line">&#125;));</div></pre></td></tr></table></figure>
<p>其实就是判断环境是什么，然后输出对应的模块定义。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/04/2016-11-04-cache-control/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magma's fe blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/04/2016-11-04-cache-control/" itemprop="url">服务器配置静态资源的缓存策略</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-04T00:00:00+08:00">
                2016-11-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>这篇源自上篇博客，在调研chrome的cache comporessed的时候发现自己对服务器设置各种缓存策略不是很了解。你可能已经注意到这个标题有些奇怪，我本来的名字是【浏览器缓存策略】，但是容易与cookie、session，甚至是localstorage之流混为一谈，所以起了个有些复杂的名字。</p>
</blockquote>
<h2 id="环境、前提"><a href="#环境、前提" class="headerlink" title="环境、前提"></a>环境、前提</h2><blockquote>
<p>以下测试阐述用例使用的是nginx 1.8.1。</p>
</blockquote>
<h2 id="Expires"><a href="#Expires" class="headerlink" title="Expires"></a>Expires</h2><p>资源的过期时间，这是个时间点。它的运行机制如下：</p>
<ol>
<li>服务器设置资源A的过期时间为 <strong>Mon, 07 Nov 2016 09:45:28 GMT</strong></li>
<li>客户端第一次访问A时，下载资源200。再次访问资源A时，如果客户端时间在Expires之前，则直接从缓存中读取A，状态为 200 from cache.否则再次请求服务器。</li>
</ol>
<p>Expires定义于http1.0，虽然浏览器依然处理此策略，但是http1.1定义的cache-control更犀利、全面。需要注意的是如果使用nginx测试，其中expires字段并不是Expires，见关联知识第二点。</p>
<h2 id="Cache-Control相关"><a href="#Cache-Control相关" class="headerlink" title="Cache-Control相关"></a>Cache-Control相关</h2><p>Cache-Control的常用取值（其实是我理解的，其他的不理解不敢瞎写）：</p>
<ol>
<li>max-age=t,在t秒内不会再次请求此资源，当此项与Expires同时存在时，此项优先级高于Exprires。</li>
<li>no-cache,不直接使用本地缓存，每次会去服务器验证有效性，所以可能会触发304 cache.</li>
<li>no-store,完全不使用缓存。</li>
<li>public,缓存所有资源。</li>
</ol>
<p><strong>Cache-Control与Expires同时设置时，Cache-Control的优先级高于Expires。</strong></p>
<h3 id="Last-Modified-If-Modified-Since"><a href="#Last-Modified-If-Modified-Since" class="headerlink" title="Last-Modified/If-Modified-Since"></a>Last-Modified/If-Modified-Since</h3><p>如果服务器开启此功能，其运行机制如下：</p>
<ol>
<li>客户端第一次请求资源A时，返回资源A的 response-header 中有 Last-Modified字段</li>
<li>第二次请求A资源，并且此资源过期（Expires的设置，或者Cache-Control设置），客户端发送一个带有If-Modified-Since字段的请求去服务器，服务器对比A资源的最后修改时间T与客户端发送过来的If-Modified-Since。如果T&gt;If-Modified-Since,返回状态码200，并完全返回资源A的数据。如果 T = If-Modified-Since，返回304，客户端从缓存中读取A的数据。如果T &lt; If-Modified-Since,那么这是个非法请求。</li>
</ol>
<h3 id="Etag-If-None-Match"><a href="#Etag-If-None-Match" class="headerlink" title="Etag/If-None-Match"></a>Etag/If-None-Match</h3><p>Etag与Last-Modified的机制一样，不同的是Etag有生成规则，用以区分同一文件在时间维度上的不同。Etag提出主要是解决以下Last-Modified不能解决的问题：</p>
<ol>
<li>Last-Modified只能精确到秒级，如果1秒内多次修改，可能造成缓存到客户端的不是最新的资源。</li>
<li>某些文件定时更新，客户端关心的资源并没有变化，但Last-Modified改变了，将无法使用缓存。</li>
<li>有可能存在服务器没有准确获取文件修改时间，或者与代理服务器时间不一致等情形。</li>
</ol>
<p>注意，当Etag和Last-Modified一起设置时，Etag的优先级高于Last-Modified，但并不是覆盖。</p>
<h2 id="缓存应用流程图"><a href="#缓存应用流程图" class="headerlink" title="缓存应用流程图"></a>缓存应用流程图</h2><h3 id="客户端第一次请求资源"><a href="#客户端第一次请求资源" class="headerlink" title="客户端第一次请求资源"></a>客户端第一次请求资源</h3><p><img src="/image/first_request.png"></p>
<h3 id="客户端第二次请求资源"><a href="#客户端第二次请求资源" class="headerlink" title="客户端第二次请求资源"></a>客户端第二次请求资源</h3><p><img src="/image/second_request.png"></p>
<p>哈哈~，这两张图是盗的，来自于参考项的文章中。</p>
<h2 id="关联知识"><a href="#关联知识" class="headerlink" title="关联知识"></a>关联知识</h2><ul>
<li>GMT时间，格林尼治时间，北京时间是东八区，这个八就是相对格林尼治，所以北京时间减8个小时就是GMT。</li>
<li>ngx_http_headers_module，此模块总是在response header上追加 Expires 和 Cache-Control字段，同时expires不设置为 off时，Expires和Cache-Control会因为expires的设置而被修改。参考:<a href="http://nginx.org/en/docs/http/ngx_http_headers_module.html#expires" target="_blank" rel="external">Module ngx_http_headers_module</a></li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.cnblogs.com/skynet/archive/2012/11/28/2792503.html" target="_blank" rel="external">http://www.cnblogs.com/skynet/archive/2012/11/28/2792503.html</a><br><a href="https://www.mnot.net/cache_docs/" target="_blank" rel="external">https://www.mnot.net/cache_docs/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/31/2016-10-31-simple-require-js/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magma's fe blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/31/2016-10-31-simple-require-js/" itemprop="url">简述AMD的实现库: requirejs</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-31T00:00:00+08:00">
                2016-10-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>requirejs是AMD的一种实现，主要通过按依赖顺序向html中插入scripts节点来实现模块的依赖加载。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>requirejs先加载入口文件，如果入口文件有依赖，则加载这些依赖文件，如果依赖还有自己的依赖…直到加载完所有的依赖。requrejs的define函数用来定义可加载的js模块，它的语法是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">define(id?,deps?,factory)</div></pre></td></tr></table></figure>
<h3 id="requirejs的内部变量"><a href="#requirejs的内部变量" class="headerlink" title="requirejs的内部变量"></a>requirejs的内部变量</h3><p>id 和 deps都不是必选的，factory才是模块的内容。那么define到底做了什么事呢？这得说到requirejs内部的一些对象，下面的代码是requirejs一开始定义的变量，它秉承了先声明后使用的原则把内部所用的变量一股脑声明在了函数内部的最前面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">var</span> req, s, head, baseElement, dataMain, src,</div><div class="line">interactiveScript, currentlyAddingScript, mainScript, subPath,</div><div class="line">version = <span class="string">'2.3.2'</span>,</div><div class="line">commentRegExp = <span class="regexp">/\/\*[\s\S]*?\*\/|([^:"'=]|^)\/\/.*$/mg</span>,</div><div class="line">cjsRequireRegExp = <span class="regexp">/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g</span>,</div><div class="line">jsSuffixRegExp = <span class="regexp">/\.js$/</span>,</div><div class="line">currDirRegExp = <span class="regexp">/^\.\//</span>,</div><div class="line">op = <span class="built_in">Object</span>.prototype,</div><div class="line">ostring = op.toString,</div><div class="line">hasOwn = op.hasOwnProperty,</div><div class="line">isBrowser = !!(<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="keyword">typeof</span> navigator !== <span class="string">'undefined'</span> &amp;&amp; <span class="built_in">window</span>.document),</div><div class="line">isWebWorker = !isBrowser &amp;&amp; <span class="keyword">typeof</span> importScripts !== <span class="string">'undefined'</span>,</div><div class="line"><span class="comment">//PS3 indicates loaded and complete, but need to wait for complete</span></div><div class="line"><span class="comment">//specifically. Sequence is 'loading', 'loaded', execution,</span></div><div class="line"><span class="comment">// then 'complete'. The UA check is unfortunate, but not sure how</span></div><div class="line"><span class="comment">//to feature test w/o causing perf issues.</span></div><div class="line">readyRegExp = isBrowser &amp;&amp; navigator.platform === <span class="string">'PLAYSTATION 3'</span> ?</div><div class="line">              <span class="regexp">/^complete$/</span> : <span class="regexp">/^(complete|loaded)$/</span>,</div><div class="line">defContextName = <span class="string">'_'</span>,</div><div class="line"><span class="comment">//Oh the tragedy, detecting opera. See the usage of isOpera for reason.</span></div><div class="line">isOpera = <span class="keyword">typeof</span> opera !== <span class="string">'undefined'</span> &amp;&amp; opera.toString() === <span class="string">'[object Opera]'</span>,</div><div class="line">contexts = &#123;&#125;,</div><div class="line">cfg = &#123;&#125;,</div><div class="line">globalDefQueue = [],</div><div class="line">useInteractive = <span class="literal">false</span>;</div></pre></td></tr></table></figure>
<p>除了contexts之外，其他的类似于程序设计中的静态单例，或是辅助空间，所有的逻辑还是隐藏在了contexts中。在这个2.3.2的版本中，用来生成contexts实例的newContext函数从200行开始，直到1798行结束。。。所以没办法，我们打开newContext函数，把它的变量也扒出来。</p>
<h3 id="newContext"><a href="#newContext" class="headerlink" title="newContext"></a>newContext</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> inCheckLoaded, Module, context, handlers,</div><div class="line">checkLoadedTimeoutId,</div><div class="line">config = &#123;</div><div class="line">    <span class="comment">//Defaults. Do not set a default for map</span></div><div class="line">    <span class="comment">//config to speed up normalize(), which</span></div><div class="line">    <span class="comment">//will run faster if there is no default.</span></div><div class="line">    waitSeconds: <span class="number">7</span>,</div><div class="line">    <span class="attr">baseUrl</span>: <span class="string">'./'</span>,</div><div class="line">    <span class="attr">paths</span>: &#123;&#125;,</div><div class="line">    <span class="attr">bundles</span>: &#123;&#125;,</div><div class="line">    <span class="attr">pkgs</span>: &#123;&#125;,</div><div class="line">    <span class="attr">shim</span>: &#123;&#125;,</div><div class="line">    <span class="attr">config</span>: &#123;&#125;</div><div class="line">&#125;,</div><div class="line">registry = &#123;&#125;,</div><div class="line"><span class="comment">//registry of just enabled modules, to speed</span></div><div class="line"><span class="comment">//cycle breaking code when lots of modules</span></div><div class="line"><span class="comment">//are registered, but not activated.</span></div><div class="line">enabledRegistry = &#123;&#125;,</div><div class="line">undefEvents = &#123;&#125;,</div><div class="line">defQueue = [],</div><div class="line">defined = &#123;&#125;,</div><div class="line">urlFetched = &#123;&#125;,</div><div class="line">bundlesMap = &#123;&#125;,</div><div class="line">requireCounter = <span class="number">1</span>,</div><div class="line">unnormalizedCounter = <span class="number">1</span>;</div></pre></td></tr></table></figure>
<p>通过官方文档我们知道入口文件用 requirejs.config 来启动的，这个函数执行时即开始加载依赖，我们把这个入口文件叫做依赖树的根——尽管存在一个文件可能被好几个上级资源依赖的情况，这里为叙述方便仍称其为树。除了根之外节点都会被构建为Module（newContext内部定义的模块对象）对象，临时存放于<strong>enabledRegistry</strong>这个变量中。需要注意的是，只是刚刚激活的模块才会在这个变量中短暂停留，随后就会被清除，它的作用像是一个buffer。</p>
<h3 id="define函数的作用"><a href="#define函数的作用" class="headerlink" title="define函数的作用"></a>define函数的作用</h3><p>我们回到前面的问题，define到底做了什么？</p>
<p>define将模块格式化为一个数组：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[id,deps,factory]</div></pre></td></tr></table></figure>
<p>并将其 push 进全局变量 globalDefQueue 中 —— 上面说过，这是个缓冲池。然后contexts会从其中拿数据并构建为Module对象存放于自己内部变量中,Module对象主要模式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">exports</span>:define中factory执行返回的对象，如果factory不是可执行函数则直接返回factory</div><div class="line">    ,<span class="attr">factory</span>:即define中的factory</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当此Module被上层函数依赖时，则返回其exports到上层函数的arguments中，执行这个操作的关键函数为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line"> * Executes a module callback function. Broken out as a separate function</div><div class="line"> * solely to allow the build system to sequence the files in the built</div><div class="line"> * layer in the right sequence.</div><div class="line"> *</div><div class="line"> * @private</div><div class="line"> */</div><div class="line">execCb: <span class="function"><span class="keyword">function</span> (<span class="params">name, callback, args, exports</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> callback.apply(exports, args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="简单的requirejs实现"><a href="#简单的requirejs实现" class="headerlink" title="简单的requirejs实现"></a>简单的requirejs实现</h2><p>好了，专业库因为要考虑很多方面，不容易直接洞察其主要逻辑。其实我些年的经验时，需求是最好的文档，当你了解需求，直接读源码就行了——甚至直接去造轮子了。下面我们就造个劣质小轮子 —— 这是了解一个库最好的方式了。</p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> define,<span class="built_in">require</span>;</div><div class="line"><span class="built_in">require</span> = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>)</span>&#123;</div><div class="line">	<span class="keyword">let</span> &#123;entry,baseUrl&#125; = options;</div><div class="line">	<span class="comment">//存放所有生成的模块</span></div><div class="line">	<span class="keyword">var</span> modules  = &#123;&#125;,</div><div class="line">		unLoadedModules = [];<span class="comment">//每当有script_onload触发时，则shift一个模块，生成Module</span></div><div class="line"></div><div class="line">	<span class="comment">//根据id加载一个模块，数据结构如下</span></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">loadModule</span>(<span class="params">id</span>)</span>&#123;</div><div class="line">		<span class="keyword">var</span> node = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</div><div class="line">        node.setAttribute(<span class="string">'data-modid'</span>, id);</div><div class="line">        node.src = baseUrl+id+<span class="string">".js"</span>;</div><div class="line"></div><div class="line">    	node.addEventListener(<span class="string">'load'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">    		<span class="comment">//当前脚本加载的模块名</span></div><div class="line">    		<span class="keyword">var</span> id = e.target.getAttribute(<span class="string">"data-modid"</span>);</div><div class="line">    		completeLoaded(id);</div><div class="line"></div><div class="line">    		<span class="comment">//对所有可以导出export的模块进行导出</span></div><div class="line">    		tryLoading()</div><div class="line">    	&#125;, <span class="literal">false</span>);</div><div class="line"></div><div class="line">    	<span class="built_in">document</span>.head.appendChild(node);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/*   *   *   *   *   *   *   *   *   *   *</span></div><div class="line">	 *  Module用于构建存放于modules中的模块实例    </div><div class="line">	 *   *   *   *   *   *   *   *   *   *   */</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">Module</span>(<span class="params">id,deps,factory</span>)</span>&#123;</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">		<span class="keyword">this</span>.deps = deps;<span class="comment">//["a","b"]</span></div><div class="line">		<span class="keyword">this</span>.factory = factory;</div><div class="line">		<span class="keyword">this</span>.loaded = <span class="literal">false</span>;</div><div class="line">		<span class="keyword">this</span>.export = <span class="literal">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Module.prototype = &#123;</div><div class="line">		<span class="attr">getExport</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">			<span class="comment">//如果export不存在，则构建</span></div><div class="line">			<span class="keyword">if</span> (!<span class="keyword">this</span>.export) &#123;</div><div class="line">				<span class="keyword">var</span> _args = <span class="keyword">this</span>.deps.map(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</div><div class="line">					<span class="keyword">return</span> modules[item].export;</div><div class="line">				&#125;)</div><div class="line">				<span class="keyword">this</span>.export = <span class="keyword">this</span>.factory.apply(<span class="literal">null</span>,_args);</div><div class="line">				<span class="keyword">this</span>.loaded = <span class="literal">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.export;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//当一个远程脚本完成加载时,从unLoadedModules中左移出一个模块.</span></div><div class="line">	<span class="comment">//将此模块格式化成Module对象，存放于modules中</span></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">completeLoaded</span>(<span class="params">id</span>)</span>&#123;</div><div class="line">		<span class="keyword">if</span> (unLoadedModules.length) &#123;</div><div class="line">			<span class="keyword">var</span> mod = unLoadedModules.shift();</div><div class="line">			mod[<span class="number">0</span>] = id;</div><div class="line"></div><div class="line">			modules[id] = <span class="keyword">new</span> Module(mod[<span class="number">0</span>],mod[<span class="number">1</span>],mod[<span class="number">2</span>]);</div><div class="line"></div><div class="line">			<span class="comment">//如果是无依赖模块，则立即得到它的export()</span></div><div class="line">			<span class="keyword">if</span> (mod[<span class="number">1</span>].length == <span class="number">0</span>) &#123;</div><div class="line">				modules[id].getExport()</div><div class="line">			&#125;</div><div class="line">		&#125;	</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//尝试对modules中依赖加载完成的模块生成export</span></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">tryLoading</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">var</span> _modsname = <span class="built_in">Object</span>.keys(modules);</div><div class="line"></div><div class="line">		_modsname.map(<span class="function"><span class="params">modname</span>=&gt;</span>&#123;</div><div class="line">			<span class="keyword">var</span> __Mod = modules[modname];</div><div class="line"></div><div class="line">			<span class="keyword">var</span> deps = __Mod.deps;</div><div class="line">			<span class="keyword">var</span> canExport = <span class="literal">true</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (deps.length&gt;<span class="number">0</span>) &#123;</div><div class="line">				<span class="comment">//检测是否所有依赖都已完成加载</span></div><div class="line">				deps.map(<span class="function"><span class="params">depname</span>=&gt;</span>&#123;</div><div class="line">					<span class="keyword">if</span> (!modules[depname] || modules[depname].loaded == <span class="literal">false</span>) &#123;</div><div class="line">						canExport = <span class="literal">false</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;)</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (canExport &amp;&amp; __Mod.loaded == <span class="literal">false</span>) &#123;</div><div class="line">				__Mod.getExport()</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">		&#125;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//两个参数都是必须的</span></div><div class="line">	define = <span class="function"><span class="keyword">function</span>(<span class="params">deps,factory</span>)</span>&#123;</div><div class="line">		unLoadedModules.push([<span class="literal">null</span>,deps,factory]);</div><div class="line">		<span class="keyword">if</span> (deps.length&gt;<span class="number">0</span>) &#123;</div><div class="line">			deps.map(<span class="function"><span class="params">_mod</span>=&gt;</span>&#123;</div><div class="line">				loadModule(_mod);</div><div class="line">			&#125;)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">//从入口启动</span></div><div class="line">	loadModule(entry)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">waitForEntry</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">if</span> (modules[entry] &amp;&amp; modules[entry].loaded == <span class="literal">false</span>) &#123;</div><div class="line">			tryLoading();</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			setTimeout(waitForEntry,<span class="number">50</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	waitForEntry()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现requirejs有几个重要的点</p>
<ul>
<li>在根据名称加载依赖时，依赖的define未知。即依赖的名称如何与返回的脚本定义绑定。当然可以在定义的时候把id也写上，但是这样就需要跟文件名再来一次绑定，增加了复杂度。上面这个例子中利用插入script标签的顺序，和这些标签的onload事件触发的顺序完成一致这个特性来完成绑定的。<strong>如果当中有标签加载失败，则会导致它们的顺序错乱而对应不上。</strong></li>
<li>其次只有一个模块的依赖全部加载完，才能执行factory生成export。上面这个简单的例子，是每次有一个模块load完的时候，就检测所有模块是否具有执行factory的条件。这显然不是一个好方法。而且最后的入口模块无法检测（所以我写了个循环，waitForEntry）。</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>这个劣质轮子的使用非常简单，我写了个<a href="https://github.com/magmaliang/simple_require" target="_blank" rel="external">demo</a>,一看便知。</p>
<h3 id="延伸"><a href="#延伸" class="headerlink" title="延伸"></a>延伸</h3><p>前端性能优化肯定需要把所有依赖合并成一个文件，然后压缩。。。grunt里面有一个插件 grunt-contrib-requirejs就是干这事的。然后本地使用requirejs调试，根本不需要预编译（合并，压缩）,发布时直接跑下grunt任务（多数是在代码仓库端执行的），不得不说开发与发布都非常方便。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/31/2016-11-01-introduction-to-chrome-cache-compress/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="magma">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="magma's fe blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/31/2016-11-01-introduction-to-chrome-cache-compress/" itemprop="url">chrome 缓存压缩--记一次脚本加载时间过长的分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-31T00:00:00+08:00">
                2016-10-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本文的结论在很久前就注意过，并且了解到浏览器的缓存压缩，但是没有记录、没有深入调研，不够了解自然不能运用自如。</p>
</blockquote>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>这个问题很早就出现，因为其他更紧急的事，没有分析。情况是这样的，我们有几个比较大的js脚本，平均在1MB~2MB之间（压缩前），在chrome下304的情况下加载都需要平均600毫秒的时间。</p>
<h2 id="问题分析经过"><a href="#问题分析经过" class="headerlink" title="问题分析经过"></a>问题分析经过</h2><blockquote>
<p>以下测试数据皆在我自己的mac上进行，在其他机器上数据偏差量可能非常大。</p>
</blockquote>
<h3 id="一-是否是服务器原因"><a href="#一-是否是服务器原因" class="headerlink" title="一.是否是服务器原因"></a>一.是否是服务器原因</h3><p>之所以会考虑这个原因，是因为我们使用了nginx rewrite模块，这还不算完，rewrite之后还要使用proxy_pass代理到node启的端口上，我害怕这条路太过曲折。所以我把一个大文件直接在nginx里location出去。</p>
<p>然后……chrome下<br><br><br><img src="/image/chrome-200.png" alt="/image/chrome-200.png"></p>
<h3 id="二-是否是网络原因"><a href="#二-是否是网络原因" class="headerlink" title="二.是否是网络原因"></a>二.是否是网络原因</h3><p>因为使用的是本地的静态资源服务器(127.0.0.1)，网络出现原因只能是到本地服务器的建连时间。但是我还是手贱地ping了下</p>
<p><img src="/image/pinglocal.png" style="width:70%;"></p>
<p>这个时间，业界良心，没得说了。</p>
<p>如何彻底绝了这念想，我只好触发200 from cache了。</p>
<p>chrome下的结果：</p>
<p><img src="/image/chrome-200cache.png" alt="/image/chrome-200.png"></p>
<p>完全跟网络无关的加载都如此耗时，这….绝逼是浏览器的原因了，为了证实此问题。</p>
<h3 id="三-证明是chrome的原因"><a href="#三-证明是chrome的原因" class="headerlink" title="三.证明是chrome的原因"></a>三.证明是chrome的原因</h3><p>这时候我打开了尘封已久的safari,看了下资源304时的timeline.</p>
<p><img src="/image/safari-200cache.png" alt="/image/chrome-200.png"></p>
<p>尼玛，这数据似曾相识？<br><br><br><img src="/image/ping.jpg" width="30%"></p>
<p>我又浪费公司带宽去下载了一个80MB的firefox,304缓存时间如下：<br><br><br><img src="/image/firefox_304.png"></p>
<h3 id="四-理论依据"><a href="#四-理论依据" class="headerlink" title="四.理论依据"></a>四.理论依据</h3><p>作为一个程序员，仅仅用事实说话是不行的……还得用代码说话。。。只可惜。。<br>我看不懂chrome的代码，那时候整天哔哔哔微软不开源，现在开源的也看不懂，尴尬。所以又去读了几遍chrome timing相关的<a href="https://developers.google.com/web/tools/chrome-devtools/network-performance/resource-loading#view-network-timing-details-for-a-specific-resource" target="_blank" rel="external">文档</a>，还是没搞明白。</p>
<p>只好low爆地去搜，“Chrome spend too much time downloading resourece from cache”，结果只找到了这一篇<a href="http://stackoverflow.com/questions/33250802/why-does-chrome-spend-time-downloading-content-from-cache" target="_blank" rel="external">Why does Chrome spend time “downloading” content from cache?</a>,这个回答指引我找到了最终的答案，但只有可怜的3个赞，我顺手一点，结果说我声望不够，不准我点赞，于是我又google如何获取声望~~~。</p>
<p>这位兄台说到：</p>
<blockquote>
<p>You’ll also notice that Chrome is spending time “downloading” every file. Why is this? Well, Chrome’s cache is a database, and that database is also compressed to save space. When you retrieve a document from cache, the price of that retrieval is not zero. Chrome has to look up the item in the cache database, and then inflate that entry into memory so Chrome can work with it. I don’t know the exact details concerning how the Network chrome-dev-tools panel shows the times, but I would guess that getting that file from disk, uncompressing it, and then parsing and working with the result is what you’re seeing reflected in “Time downloaded.”</p>
</blockquote>
<p>进一步搜索找到这篇<a href="https://www.stevesouders.com/blog/2012/03/27/cache-compressed-or-uncompressed/" target="_blank" rel="external">文章</a>。可以看到chrome,firefox和Opera进行了压缩，IE和Safari没有。这说明了我上面测试的结果，从safari加载304缓存的速度几乎和ping的速度一样。chrome相比于firefox，解压加载的速度几乎慢了两个数量级，这应该是chrome的压缩率更高，所以解压速度更长。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><blockquote>
<p>Chrome压缩了缓存，从缓存中加载需要解压 —— No free lunch.</p>
</blockquote>
<script>
    var imgs = document.images;
    for(var i =0;i<imgs.length;i++){
        imgs[i].addEventListener("mousedown",function(e){
            var str = e.target.getAttribute("src");
            window.open(str,"_blank")
        })
    }
</script>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="magma" />
          <p class="site-author-name" itemprop="name">magma</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">magma</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

  

</body>
</html>
